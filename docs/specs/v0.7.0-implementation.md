# v0.7.0 Implementation Specification

This document provides detailed implementation specifications for all v0.7.0 features.

## Table of Contents

1. [Watch Command](#1-watch-command)
2. [Init Command](#2-init-command)
3. [Pre-commit Hook Installation](#3-pre-commit-hook-installation)
4. [Interactive Fix Mode](#4-interactive-fix-mode)
5. [Explain Command](#5-explain-command)
6. [Diff-Aware Linting](#6-diff-aware-linting)
7. [New Dependencies](#7-new-dependencies)
8. [Testing Strategy](#8-testing-strategy)

---

## 1. Watch Command

### File Structure

```
src/cli/commands/watch.ts          # Watch command implementation
src/infrastructure/FileWatcher.ts  # Chokidar wrapper
```

### Interface Definitions

```typescript
// src/cli/commands/watch.ts
export interface WatchOptions {
  recursive: boolean;
  fix: boolean;
  debounce: number;
  clear: boolean;
  config?: string;
}

// src/infrastructure/FileWatcher.ts
export interface FileWatcherOptions {
  patterns: string[];
  recursive: boolean;
  debounceMs: number;
  ignored?: string[];
}

export interface FileChangeEvent {
  type: 'add' | 'change' | 'unlink';
  path: string;
  timestamp: Date;
}

export class FileWatcher {
  constructor(options: FileWatcherOptions);

  on(event: 'change', callback: (event: FileChangeEvent) => void): this;
  on(event: 'error', callback: (error: Error) => void): this;
  on(event: 'ready', callback: () => void): this;

  start(): Promise<void>;
  stop(): Promise<void>;
}
```

### Command Implementation

```typescript
// src/cli/commands/watch.ts
import { Command } from 'commander';
import { FileWatcher } from '../../infrastructure/FileWatcher.js';

export const watchCommand = new Command('watch')
  .description('Watch CLAUDE.md files for changes and lint on save')
  .argument('[patterns...]', 'File patterns to watch', [
    'CLAUDE.md',
    '**/CLAUDE.md',
  ])
  .option('-r, --recursive', 'Watch directories recursively', true)
  .option('--fix', 'Automatically fix problems on save', false)
  .option('--debounce <ms>', 'Debounce delay in milliseconds', '300')
  .option('--no-clear', 'Do not clear console between runs')
  .option('-c, --config <path>', 'Path to configuration file')
  .action(async (patterns: string[], options: WatchOptions) => {
    // Implementation
  });
```

### User Experience

```
$ cclint watch

ğŸ‘ï¸  Watching for changes...
   Patterns: CLAUDE.md, **/CLAUDE.md
   Debounce: 300ms
   Auto-fix: disabled

Press Ctrl+C to stop

[10:30:15] Changed: CLAUDE.md
âœ… CLAUDE.md - 0 errors, 2 warnings

[10:30:42] Changed: docs/CLAUDE.md
âŒ docs/CLAUDE.md - 1 error, 0 warnings
   Line 15: Missing required section: Development Commands
```

---

## 2. Init Command

### File Structure

```
src/cli/commands/init.ts           # Init command implementation
src/infrastructure/Scaffolder.ts   # Template engine
src/infrastructure/ProjectDetector.ts # Project type detection
src/templates/                     # Template files
  â”œâ”€â”€ minimal.md
  â”œâ”€â”€ typescript.md
  â”œâ”€â”€ python.md
  â”œâ”€â”€ go.md
  â”œâ”€â”€ monorepo.md
  â”œâ”€â”€ library.md
  â””â”€â”€ api.md
```

### Interface Definitions

```typescript
// src/infrastructure/ProjectDetector.ts
export type ProjectType =
  | 'typescript'
  | 'javascript'
  | 'python'
  | 'go'
  | 'rust'
  | 'java'
  | 'unknown';

export type ProjectStructure =
  | 'monorepo'
  | 'library'
  | 'api'
  | 'cli'
  | 'web'
  | 'standard';

export interface DetectionResult {
  type: ProjectType;
  structure: ProjectStructure;
  confidence: number; // 0-1
  evidence: string[]; // Files that led to detection
  packageManager?: string; // npm, yarn, pnpm, pip, go mod, etc.
  testFramework?: string; // jest, vitest, pytest, etc.
  ciSystem?: string; // github, gitlab, etc.
}

export class ProjectDetector {
  constructor(rootDir: string);
  detect(): Promise<DetectionResult>;
}

// src/infrastructure/Scaffolder.ts
export interface ScaffoldOptions {
  template: string;
  projectName?: string;
  projectDescription?: string;
  overwrite: boolean;
  detection?: DetectionResult;
}

export interface ScaffoldResult {
  path: string;
  content: string;
  wasOverwritten: boolean;
}

export class Scaffolder {
  constructor(templatesDir: string);

  listTemplates(): string[];
  scaffold(options: ScaffoldOptions): Promise<ScaffoldResult>;
  renderTemplate(template: string, vars: Record<string, string>): string;
}
```

### Template Variables

Templates use Handlebars-style placeholders:

````markdown
# {{projectName}}

{{projectDescription}}

## Development Commands

```bash
# Install dependencies
{{installCommand}}

# Run tests
{{testCommand}}

# Build
{{buildCommand}}
```
````

````

### Command Implementation

```typescript
// src/cli/commands/init.ts
export const initCommand = new Command('init')
  .description('Create a new CLAUDE.md file')
  .option('-t, --template <name>', 'Template to use', 'minimal')
  .option('--detect', 'Auto-detect project type')
  .option('-i, --interactive', 'Interactive mode with prompts')
  .option('-f, --force', 'Overwrite existing CLAUDE.md')
  .option('-o, --output <path>', 'Output path', 'CLAUDE.md')
  .action(async (options) => {
    // Implementation
  });
````

### Interactive Mode Flow

```
$ cclint init -i

ğŸš€ Create a new CLAUDE.md

? Project name: my-awesome-project
? Short description: A TypeScript library for data processing
? Template: (Use arrow keys)
â¯ minimal     - Basic structure with 3 sections
  typescript  - TypeScript/Node.js project
  python      - Python project
  go          - Go project
  monorepo    - Multi-package repository
  library     - Published package
  api         - REST/GraphQL API

? Detected as TypeScript project. Use detected settings? Yes

âœ… Created CLAUDE.md

Tip: Run `cclint lint CLAUDE.md` to validate your new file.
```

---

## 3. Pre-commit Hook Installation

### File Structure

```
src/cli/commands/hook.ts               # Hook commands (install/uninstall)
src/infrastructure/HookManager.ts      # Hook installation logic
src/infrastructure/hooks/              # Hook scripts
  â”œâ”€â”€ husky-hook.sh
  â”œâ”€â”€ lefthook-hook.sh
  â””â”€â”€ git-hook.sh
```

### Interface Definitions

```typescript
// src/infrastructure/HookManager.ts
export type HookManagerType = 'husky' | 'lefthook' | 'pre-commit' | 'git';

export interface HookConfig {
  manager: HookManagerType;
  fix: boolean;
  staged: boolean;
  patterns: string[];
}

export interface HookInstallResult {
  success: boolean;
  manager: HookManagerType;
  hookPath: string;
  message: string;
}

export class HookManager {
  constructor(rootDir: string);

  detect(): HookManagerType | null;
  install(config: HookConfig): Promise<HookInstallResult>;
  uninstall(): Promise<HookInstallResult>;
  isInstalled(): Promise<boolean>;
}
```

### Hook Script Templates

```bash
# Husky hook (.husky/pre-commit)
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# cclint pre-commit hook
npx cclint lint {{patterns}} {{fixFlag}} {{stagedFlag}}
```

```yaml
# Lefthook hook (lefthook.yml addition)
pre-commit:
  commands:
    cclint:
      glob: '**/CLAUDE.md'
      run: npx cclint lint {staged_files} {{fixFlag}}
```

### Command Implementation

```typescript
// src/cli/commands/hook.ts
export const installHookCommand = new Command('install-hook')
  .description('Install Git pre-commit hook for cclint')
  .option('--fix', 'Enable auto-fix in hook')
  .option('--staged', 'Only lint staged files')
  .option(
    '-m, --manager <type>',
    'Hook manager to use (husky|lefthook|pre-commit|git)'
  )
  .action(async options => {
    // Implementation
  });

export const uninstallHookCommand = new Command('uninstall-hook')
  .description('Remove cclint Git pre-commit hook')
  .action(async () => {
    // Implementation
  });
```

---

## 4. Interactive Fix Mode

### File Structure

```
src/cli/commands/lintEnhanced.ts       # Add --interactive flag
src/cli/interactive/InteractiveFixer.ts # Interactive session handler
src/cli/interactive/FixPreview.ts      # Fix preview renderer
```

### Interface Definitions

```typescript
// src/cli/interactive/InteractiveFixer.ts
export type InteractiveAction =
  | 'apply'
  | 'skip'
  | 'apply-all'
  | 'skip-all'
  | 'quit'
  | 'help';

export interface InteractiveState {
  violations: ViolationWithFix[];
  currentIndex: number;
  applied: number[];
  skipped: number[];
}

export interface ViolationWithFix {
  violation: Violation;
  fix: AutoFix | null;
  preview: string;
}

export class InteractiveFixer {
  constructor(
    violations: Violation[],
    content: string,
    customRules: CustomRule[]
  );

  async run(): Promise<InteractiveResult>;

  private promptForAction(): Promise<InteractiveAction>;
  private renderViolation(index: number): void;
  private applyFix(index: number): void;
}

export interface InteractiveResult {
  totalViolations: number;
  appliedFixes: number;
  skippedFixes: number;
  newContent: string;
}
```

### Terminal UI

```
â”Œâ”€ Fix 1 of 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rule: content-appropriateness                                  â”‚
â”‚ Severity: âš ï¸  warning                                          â”‚
â”‚ Location: Line 45, Column 1                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Message:                                                       â”‚
â”‚ Generic instruction detected. Be more specific.                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Current (Line 45):                                             â”‚
â”‚ > Follow best practices for error handling.                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Suggested Fix:                                                 â”‚
â”‚ > Use try-catch blocks for async operations.                   â”‚
â”‚ > Log errors with stack traces to stderr.                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[a] Apply  [s] Skip  [A] Apply all  [S] Skip all  [q] Quit  [?] Help
>
```

---

## 5. Explain Command

### File Structure

```
src/cli/commands/explain.ts            # Explain command
src/domain/RuleMetadata.ts             # Rule metadata type
src/rules/*.ts                         # Add metadata to each rule
```

### Interface Definitions

```typescript
// src/domain/RuleMetadata.ts
export interface RuleMetadata {
  id: string;
  name: string;
  description: string;
  category: RuleCategory;
  severity: Severity;
  rationale: string;
  examples: RuleExample[];
  options: RuleOptionDoc[];
  references: string[];
  since: string; // Version introduced
}

export type RuleCategory =
  | 'structure'
  | 'content'
  | 'format'
  | 'safety'
  | 'organization'
  | 'imports';

export interface RuleExample {
  title: string;
  bad?: string;
  good?: string;
  explanation: string;
}

export interface RuleOptionDoc {
  name: string;
  type: string;
  default: unknown;
  description: string;
}

// Extended Rule interface
export interface Rule {
  id: string;
  lint(file: ContextFile): Violation[];
  getMetadata(): RuleMetadata;
}
```

### Command Implementation

```typescript
// src/cli/commands/explain.ts
export const explainCommand = new Command('explain')
  .description('Get detailed documentation for rules')
  .argument('[rule]', 'Rule ID to explain')
  .option('--all', 'List all available rules')
  .option('--category <cat>', 'Filter by category')
  .option('--json', 'Output as JSON')
  .action(async (rule, options) => {
    // Implementation
  });
```

### Output Format

```
$ cclint explain content-appropriateness

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
content-appropriateness
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Category:    content
Severity:    warning
Since:       v0.6.0

Description:
  Ensures content in CLAUDE.md is specific, actionable, and
  appropriate for AI context files.

Rationale:
  Generic instructions waste context window tokens and don't provide
  Claude with useful guidance. Content should be specific to the
  project and provide actionable instructions.

Options:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Name             â”‚ Type    â”‚ Default â”‚ Description             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ maxFileSize      â”‚ number  â”‚ 5000    â”‚ Recommended file size   â”‚
  â”‚ allowGenericSecs â”‚ boolean â”‚ false   â”‚ Allow generic content   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Examples:

  âŒ Bad:
    Follow best practices for error handling.

  âœ… Good:
    Use try-catch blocks for async operations. Log errors with
    stack traces to stderr using the logger from src/utils/logger.ts.

  Explanation:
    The first example is vague and doesn't tell Claude anything
    specific about how this project handles errors. The second
    provides concrete, actionable guidance.

Related Rules:
  - content-organization
  - structure

References:
  - https://docs.anthropic.com/claude/docs/claude-md
  - ADR-006: Anthropic Alignment v0.5.0
```

---

## 6. Diff-Aware Linting

### File Structure

```
src/cli/commands/lintEnhanced.ts       # Add --diff flag
src/infrastructure/GitDiff.ts          # Git diff parsing
src/domain/DiffFilter.ts               # Violation filtering
```

### Interface Definitions

```typescript
// src/infrastructure/GitDiff.ts
export interface DiffHunk {
  startLine: number;
  lineCount: number;
  type: 'add' | 'change' | 'context';
}

export interface FileDiff {
  path: string;
  hunks: DiffHunk[];
  isNew: boolean;
  isDeleted: boolean;
}

export class GitDiff {
  constructor(rootDir: string);

  getDiff(ref: string, paths?: string[]): Promise<FileDiff[]>;
  getChangedLines(ref: string, filePath: string): Promise<Set<number>>;
  isGitRepo(): Promise<boolean>;
}

// src/domain/DiffFilter.ts
export class DiffFilter {
  constructor(changedLines: Set<number>);

  filter(violations: Violation[]): FilteredViolations;
}

export interface FilteredViolations {
  new: Violation[]; // In changed lines
  existing: Violation[]; // In unchanged lines
}
```

### Command Enhancement

```typescript
// Addition to lintEnhanced.ts
.option('--diff <ref>', 'Only report violations in changed lines (compared to ref)')
.option('--show-all', 'When using --diff, also show existing violations')
```

### Output Format

```
$ cclint lint CLAUDE.md --diff main

Comparing to: main (abc123)
Changed lines: 15-23, 45-50

NEW VIOLATIONS (in changed lines):
âŒ Line 17: Missing required section header
âš ï¸  Line 47: Generic instruction detected

EXISTING VIOLATIONS (unchanged, use --show-all to see):
  2 warnings in unchanged code

Summary: 1 error, 1 warning (new), 2 warnings (existing)
```

---

## 7. New Dependencies

### Production Dependencies

```json
{
  "dependencies": {
    "chokidar": "^3.6.0", // File watching
    "inquirer": "^9.2.0", // Interactive prompts
    "simple-git": "^3.22.0", // Git operations
    "chalk": "^5.3.0" // Terminal colors (already in commander)
  }
}
```

### Dependency Justification

| Package    | Purpose             | Size | Alternative Considered    |
| ---------- | ------------------- | ---- | ------------------------- |
| chokidar   | File watching       | 12KB | fs.watch (inconsistent)   |
| inquirer   | Interactive prompts | 45KB | prompts (less features)   |
| simple-git | Git operations      | 35KB | exec('git') (error-prone) |

---

## 8. Testing Strategy

### Test Categories

```
tests/unit/cli/
  â”œâ”€â”€ watch.test.ts           # Watch command tests
  â”œâ”€â”€ init.test.ts            # Init command tests
  â”œâ”€â”€ hook.test.ts            # Hook command tests
  â”œâ”€â”€ explain.test.ts         # Explain command tests
  â””â”€â”€ interactive.test.ts     # Interactive mode tests

tests/unit/infrastructure/
  â”œâ”€â”€ FileWatcher.test.ts     # File watcher tests
  â”œâ”€â”€ Scaffolder.test.ts      # Template scaffolding tests
  â”œâ”€â”€ ProjectDetector.test.ts # Project detection tests
  â”œâ”€â”€ HookManager.test.ts     # Hook management tests
  â””â”€â”€ GitDiff.test.ts         # Git diff tests

tests/integration/
  â”œâ”€â”€ watch-workflow.test.ts  # End-to-end watch mode
  â”œâ”€â”€ init-workflow.test.ts   # End-to-end init
  â””â”€â”€ hook-workflow.test.ts   # End-to-end hook installation
```

### Mock Strategies

```typescript
// File system mocking
import { vol } from 'memfs';
vi.mock('fs', () => require('memfs'));

// Git mocking
vi.mock('simple-git', () => ({
  simpleGit: () => ({
    diff: vi.fn().mockResolvedValue('...'),
    status: vi.fn().mockResolvedValue({ isClean: true }),
  }),
}));

// Inquirer mocking
vi.mock('inquirer', () => ({
  prompt: vi.fn().mockResolvedValue({ action: 'apply' }),
}));
```

### Test Coverage Targets

| Module             | Target |
| ------------------ | ------ |
| Watch command      | 90%    |
| Init command       | 90%    |
| Hook command       | 85%    |
| Interactive mode   | 85%    |
| Explain command    | 95%    |
| Diff-aware linting | 90%    |
| Infrastructure     | 90%    |

---

## Implementation Order

1. **Week 1**: Watch mode + FileWatcher infrastructure
2. **Week 2**: Init command + Scaffolder + ProjectDetector
3. **Week 3**: Pre-commit hooks + HookManager
4. **Week 4**: Interactive fix mode
5. **Week 5**: Explain command + Rule metadata
6. **Week 6**: Diff-aware linting + GitDiff

---

## Migration Notes

### Breaking Changes

None - all features are additive.

### Configuration Updates

New configuration options:

```json
{
  "watch": {
    "debounce": 300,
    "patterns": ["CLAUDE.md", "**/CLAUDE.md"],
    "ignore": ["node_modules/**"]
  },
  "interactive": {
    "colors": true,
    "preview": true
  }
}
```

### CLI Help Updates

```
Commands:
  lint <file>         Lint a CLAUDE.md file
  watch [patterns]    Watch files for changes
  init               Create a new CLAUDE.md file
  install-hook       Install Git pre-commit hook
  uninstall-hook     Remove Git pre-commit hook
  explain [rule]     Get rule documentation

Options:
  --interactive      Interactive fix mode (lint command)
  --diff <ref>       Diff-aware linting (lint command)
```
